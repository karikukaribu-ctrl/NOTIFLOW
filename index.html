<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>PSY-WRITER — Notes, rapports, emails, sevrage (offline)</title>
  <style>
    /* ==========
       Style: sobre, lisible, sans "effets bouton"
       ========== */
    :root{
      --bg: #0f1115;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.09);
      --line: rgba(255,255,255,0.14);
      --fg: #e9edf5;
      --muted: #a8b0bd;
      --accent: rgba(46,229,157,0.55);
      --warn: rgba(255,207,90,0.55);
      --bad: rgba(255,107,107,0.55);
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --r: 16px;

      /* Police "élégante" : on prend les meilleures system fonts dispo */
      --font: ui-sans-serif, system-ui, -apple-system, "SF Pro Display", "Segoe UI", Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    /* Light mode */
    [data-theme="light"]{
      --bg: #f7f8fb;
      --panel: rgba(0,0,0,0.04);
      --panel2: rgba(0,0,0,0.06);
      --line: rgba(0,0,0,0.10);
      --fg: #0d1321;
      --muted: #4b5563;
      --shadow: 0 18px 60px rgba(0,0,0,0.10);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0; font-family: var(--font); color: var(--fg);
      background: var(--bg);
    }

    /* Top bar fixe */
    header{
      position: sticky; top:0; z-index:10;
      background: var(--bg);
      border-bottom: 1px solid var(--line);
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px 14px;
      max-width: 1400px;
      margin:0 auto;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand b{ letter-spacing:0.4px; font-weight:800; }
    .brand small{ color: var(--muted); font-size:12px; }

    /* Boutons sans effet */
    .btn{
      border:1px solid var(--line);
      background: var(--panel);
      color: var(--fg);
      padding:9px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-weight:650;
      user-select:none;
      transition: none;           /* pas d'effet */
      box-shadow:none;
    }
    .btn:active{ transform:none; }  /* pas d'effet */
    .btn.ok{ border-color: var(--accent); }
    .btn.warn{ border-color: var(--warn); }
    .btn.bad{ border-color: var(--bad); }

    .pillbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    /* Layout global: sidebar gauche + contenu */
    .wrap{
      max-width: 1400px;
      margin:0 auto;
      padding: 12px 14px 20px;
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns:1fr; }
    }

    aside{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      position: sticky;
      top: 62px;
      height: calc(100vh - 76px);
    }
    @media (max-width: 980px){
      aside{ position: relative; top:auto; height:auto; }
    }

    .sidehead{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .sidehead b{ font-size:14px; }
    .sidebody{
      padding: 12px 12px;
      overflow:auto;
      height: calc(100% - 54px);
    }

    main .card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardhead{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      flex-wrap:wrap;
    }
    .cardhead b{ font-size:14px; }
    .chip{
      border:1px solid var(--line);
      background: var(--panel2);
      color: var(--muted);
      padding:6px 10px;
      border-radius: 999px;
      font-size:12px;
      white-space:nowrap;
    }

    .body{ padding: 12px 14px; }

    label{ display:block; color: var(--muted); font-size:12px; margin:10px 0 6px; }
    input, select, textarea{
      width:100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.10);
      color: var(--fg);
      border-radius: 12px;
      padding:10px 10px;
      font: inherit;
      outline:none;
    }
    [data-theme="light"] input,
    [data-theme="light"] select,
    [data-theme="light"] textarea{
      background: rgba(255,255,255,0.92);
    }
    textarea{ min-height: 120px; resize: vertical; }
    .mono{ font-family: var(--mono); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1 1 220px; min-width:220px; }

    /* Sections */
    .section{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px 10px;
      background: rgba(0,0,0,0.06);
      margin-top:10px;
    }
    [data-theme="light"] .section{ background: rgba(255,255,255,0.60); }

    .sectionhead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .sectionhead b{ font-size:13px; }
    .small{ color: var(--muted); font-size:12px; }

    /* Checklist */
    .checkgrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px;
    }
    @media (max-width: 980px){
      .checkgrid{ grid-template-columns:1fr; }
    }
    .chk{
      border:1px solid var(--line);
      border-radius: 12px;
      padding:8px 10px;
      display:flex; gap:10px; align-items:flex-start;
      background: rgba(0,0,0,0.06);
    }
    [data-theme="light"] .chk{ background: rgba(255,255,255,0.70); }
    .chk input{ width:auto; margin-top:3px; }
    .chk b{ font-size:13px; }
    .chk small{ color: var(--muted); display:block; margin-top:2px; font-size:12px; }

    /* Sidebar list */
    .list{ display:flex; flex-direction:column; gap:8px; }
    .item{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px 10px;
      background: rgba(0,0,0,0.06);
      cursor:pointer;
    }
    [data-theme="light"] .item{ background: rgba(255,255,255,0.70); }
    .item.active{ outline: 2px solid rgba(46,229,157,0.25); }
    .item b{ display:block; font-size:13px; }
    .item small{ display:block; color:var(--muted); margin-top:3px; font-size:12px; }

    /* Output */
    .outputwrap{ margin-top:10px; }
    .toolbar{
      padding: 10px 14px;
      border-top:1px solid var(--line);
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-end;
      background: rgba(0,0,0,0.04);
    }
    [data-theme="light"] .toolbar{ background: rgba(255,255,255,0.55); }

    /* Focus mode: on cache presque tout sauf les checklists + génération */
    body.focus aside{ display:none; }
    body.focus .wrap{ grid-template-columns: 1fr; }
    body.focus .focusHide{ display:none !important; }
  </style>
</head>

<body data-theme="dark">
<header>
  <div class="topbar">
    <div class="brand">
      <b>PSY-WRITER</b>
      <small>Notes • rapports • emails • sevrage — offline (localStorage)</small>
    </div>

    <div class="pillbar">
      <button class="btn" id="btnTheme">Mode clair/sombre</button>
      <button class="btn" id="btnFocus">Focus</button>
      <button class="btn ok" id="btnGenerate">Générer</button>
      <button class="btn" id="btnCopy">Copier</button>
      <button class="btn warn" id="btnExport">Exporter</button>
      <button class="btn" id="btnImport">Importer</button>
      <button class="btn bad" id="btnReset">Reset</button>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- Sidebar gauche -->
  <aside id="sidebar">
    <div class="sidehead">
      <b>Paramètres & modèles</b>
      <button class="btn" id="btnHideSide">Masquer</button>
    </div>
    <div class="sidebody">
      <label>Type</label>
      <select id="mode">
        <option value="clinical">Clinique</option>
        <option value="email">Email</option>
        <option value="taper">Schéma sevrage</option>
      </select>

      <div class="section">
        <div class="sectionhead">
          <b>Modèles</b>
          <span class="small" id="countTpl"></span>
        </div>
        <input id="searchTpl" placeholder="rechercher (travail, consult, sevrage…)" />
        <div style="height:8px;"></div>
        <div class="list" id="tplList"></div>
      </div>

      <div class="section">
        <div class="sectionhead"><b>Identité & style</b></div>
        <label>Identité (optionnel)</label>
        <input id="identite" placeholder="Mme X / M. Y / Initiales" />
        <label>Pronoms</label>
        <select id="civilite">
          <option value="F">F (elle)</option>
          <option value="M">M (il)</option>
          <option value="N">N (neutre)</option>
        </select>
        <label>Signature email</label>
        <input id="signature" placeholder="Dr … / Service …" />
      </div>

      <div class="section">
        <div class="sectionhead"><b>Affichage</b></div>
        <div class="row">
          <button class="btn" id="btnCompact">Compact</button>
          <button class="btn" id="btnFull">Complet</button>
        </div>
        <small class="small">Compact = moins de sections visibles.</small>
      </div>
    </div>
  </aside>

  <!-- Main -->
  <main>
    <div class="card">
      <div class="cardhead">
        <b id="docTitle">—</b>
        <div class="row" style="gap:8px;">
          <span class="chip" id="chipMode">Mode : —</span>
          <span class="chip" id="chipTpl">Modèle : —</span>
        </div>
      </div>

      <div class="body" id="content"></div>

      <div class="body outputwrap" id="outputWrap">
        <label>Texte final (modifiable)</label>
        <textarea id="output" class="mono" style="min-height:300px;"></textarea>
      </div>

      <div class="toolbar">
        <button class="btn ok" id="btnGenerate2">Générer</button>
        <button class="btn" id="btnCopy2">Copier</button>
        <button class="btn" id="btnToggleOut">Afficher/Masquer sortie</button>
        <button class="btn bad" id="btnClear">Effacer saisie (ce modèle)</button>
      </div>
    </div>
  </main>

</div>

<script>
/* =========================================================
   PSY-WRITER v1 — Offline localStorage
   - Clinique : checklists => texte fluide
   - Email : modèles prêts (bonjour + formule)
   - Sevrage : tableau auto (Valium / Ténesta)
   ========================================================= */

const LS_KEY = "psywriter_v1_state";

/* ---------- Utils ---------- */
const $ = (id)=>document.getElementById(id);
const uid = ()=> Math.random().toString(16).slice(2) + Date.now().toString(16);
const todayISO = ()=> {
  const d=new Date(); const pad=n=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
};
const todayFR = ()=> {
  const d=new Date(); const pad=n=>String(n).padStart(2,"0");
  return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()}`;
};
function pronouns(set){
  if(set==="F") return {sujet:"elle", objet:"la", poss:"sa", poss2:"son", accord:"e"};
  if(set==="M") return {sujet:"il", objet:"le", poss:"sa", poss2:"son", accord:""};
  return {sujet:"la personne", objet:"la personne", poss:"son", poss2:"son", accord:"e"};
}
function cleanSpaces(s){
  return String(s||"")
    .replace(/[ \t]+\n/g,"\n")
    .replace(/\n{3,}/g,"\n\n")
    .replace(/[ \t]{2,}/g," ")
    .trim();
}
function sentenceJoin(chunks){
  // join phrases with commas, then last with "et" if needed; returns one sentence chunk
  const a = chunks.filter(Boolean).map(x=>String(x).trim()).filter(Boolean);
  if(!a.length) return "";
  if(a.length===1) return a[0];
  if(a.length===2) return a[0] + " et " + a[1];
  return a.slice(0,-1).join(", ") + ", et " + a[a.length-1];
}
function paragraphJoin(sentences){
  const a = sentences.filter(Boolean).map(x=>String(x).trim()).filter(Boolean);
  return a.length ? a.join(" ") : "";
}
function checkboxItem(container, item, checked, onChange){
  const div=document.createElement("div");
  div.className="chk";
  const cb=document.createElement("input");
  cb.type="checkbox";
  cb.checked=!!checked;
  cb.onchange=()=>onChange(cb.checked);

  const t=document.createElement("div");
  const b=document.createElement("b"); b.textContent=item.label;
  const s=document.createElement("small"); s.textContent=item.help || item.phrase || "";
  t.appendChild(b);
  if(item.help || item.phrase) t.appendChild(s);

  div.appendChild(cb);
  div.appendChild(t);
  container.appendChild(div);
}

/* ---------- Packs (checklists) ---------- */
// Syndromes
const PACKS = {
  anxieux: {
    title:"Syndrome anxieux",
    items:[
      {id:"anx_social", label:"Anxiété sociale", phrase:"anxiété sociale importante avec évitement"},
      {id:"anx_panic", label:"Crises d’angoisse", phrase:"crises d’angoisse paroxystiques"},
      {id:"anx_rumi", label:"Ruminations", phrase:"ruminations anxieuses envahissantes"},
      {id:"anx_hyperv", label:"Hypervigilance", phrase:"hypervigilance et sentiment d’insécurité"},
      {id:"anx_sleep", label:"Sommeil", phrase:"troubles du sommeil avec sommeil non réparateur"},
      {id:"anx_ret", label:"Retentissement", phrase:"retentissement fonctionnel significatif"}
    ]
  },
  anxiodepressif: {
    title:"Syndrome anxiodépressif",
    items:[
      {id:"ad_anx", label:"Anxiété au premier plan", phrase:"anxiété au premier plan"},
      {id:"ad_down", label:"Affects dépressifs", phrase:"affects dépressifs avec baisse de l’élan"},
      {id:"ad_fatigue", label:"Épuisement", phrase:"fatigabilité importante et épuisement"},
      {id:"ad_conc", label:"Attention", phrase:"difficultés d’attention et de concentration"},
      {id:"ad_sleep", label:"Sommeil", phrase:"troubles du sommeil marqués"},
      {id:"ad_ideo", label:"Idées noires diffuses", phrase:"idées noires diffuses sans planification rapportée"}
    ]
  },
  depressif: {
    title:"Syndrome dépressif",
    items:[
      {id:"dep_anhed", label:"Anhédonie", phrase:"anhédonie et perte d’intérêt"},
      {id:"dep_vital", label:"Élan vital", phrase:"baisse de l’élan vital"},
      {id:"dep_guilt", label:"Dévalorisation", phrase:"auto-dévalorisation et culpabilité"},
      {id:"dep_sleep", label:"Sommeil", phrase:"troubles du sommeil"},
      {id:"dep_app", label:"Appétit", phrase:"altération de l’appétit"},
      {id:"dep_ideo", label:"Idées suicidaires", phrase:"idées suicidaires (à préciser cliniquement)"}
    ]
  },
  traumatique: {
    title:"Syndrome post-traumatique",
    items:[
      {id:"ptsd_reexp", label:"Réexpériences", phrase:"réexpériences intrusives (images/cauchemars)"},
      {id:"ptsd_avoid", label:"Évitement", phrase:"évitement des déclencheurs"},
      {id:"ptsd_hyper", label:"Hyperactivation", phrase:"hyperactivation avec hypervigilance/sursaut"},
      {id:"ptsd_sleep", label:"Sommeil", phrase:"troubles du sommeil marqués"},
      {id:"ptsd_ret", label:"Retentissement", phrase:"retentissement fonctionnel significatif"}
    ]
  }
};

// Consommations
const ADDICTO = {
  title:"Consommations",
  items:[
    {id:"sub_alc", label:"Alcool", phrase:"un usage d’alcool à visée anxiolytique"},
    {id:"sub_can", label:"Cannabis", phrase:"un usage de cannabis"},
    {id:"sub_coc", label:"Stimulants", phrase:"un usage de stimulants"},
    {id:"sub_bzd", label:"Benzodiazépines", phrase:"un usage de benzodiazépines (à préciser)"},
    {id:"sub_red", label:"Diminution récente", phrase:"une diminution récente des consommations"},
    {id:"sub_sport", label:"Sport ressource", phrase:"un réinvestissement d’activités ressources (notamment le sport)"}
  ]
};

// Examen mental (phrases par domaine)
const MSE = [
  {id:"app", label:"Présentation", items:[
    {id:"app_ok", label:"Adaptée", phrase:"présentation adaptée"},
    {id:"app_fat", label:"Fatiguée", phrase:"présentation fatiguée"},
    {id:"app_neg", label:"Négligée", phrase:"présentation négligée"}
  ]},
  {id:"contact", label:"Contact", items:[
    {id:"ct_ok", label:"Bon contact", phrase:"bon contact"},
    {id:"ct_coll", label:"Collaborant·e", phrase:"attitude calme et collaborante"},
    {id:"ct_mef", label:"Méfiance", phrase:"contact méfiant / prudent"},
    {id:"ct_repl", label:"Repli", phrase:"repli relationnel"}
  ]},
  {id:"disc", label:"Discours", items:[
    {id:"ds_coh", label:"Cohérent", phrase:"discours cohérent et organisé"},
    {id:"ds_ral", label:"Ralentissement", phrase:"discours ralenti"},
    {id:"ds_logo", label:"Logorrhée", phrase:"discours logorrhéique"},
    {id:"ds_pau", label:"Pauvreté", phrase:"pauvreté du discours"}
  ]},
  {id:"mood", label:"Humeur / affects", items:[
    {id:"md_anx", label:"Anxieux·se", phrase:"humeur anxieuse"},
    {id:"md_dep", label:"Dépressif·ve", phrase:"humeur dépressive"},
    {id:"md_lab", label:"Labilité", phrase:"labilité émotionnelle"},
    {id:"md_irr", label:"Irritabilité", phrase:"irritabilité"},
    {id:"md_ok", label:"Neutre/posée", phrase:"affects globalement posés"}
  ]},
  {id:"thought", label:"Pensée", items:[
    {id:"th_rum", label:"Ruminations", phrase:"ruminations envahissantes"},
    {id:"th_inv", label:"Pensées envahissantes", phrase:"pensées envahissantes"},
    {id:"th_black", label:"Idées noires", phrase:"idées noires"},
    {id:"th_del", label:"Idées délirantes", phrase:"idées délirantes (à préciser)"},
    {id:"th_obs", label:"Obsessions", phrase:"obsessions"}
  ]},
  {id:"percep", label:"Perceptions", items:[
    {id:"pc_none", label:"Pas de trouble perceptif rapporté", phrase:"aucun trouble perceptif rapporté"},
    {id:"pc_hyp", label:"Hypersensibilité/hyperacousie", phrase:"hypersensibilité sensorielle (dont au bruit)"},
    {id:"pc_hal", label:"Hallucinations (à préciser)", phrase:"troubles perceptifs rapportés (à préciser)"}
  ]},
  {id:"cogn", label:"Cognition", items:[
    {id:"cg_att", label:"Attention fluctuante", phrase:"attention fluctuante"},
    {id:"cg_fat", label:"Fatigabilité cognitive", phrase:"fatigabilité cognitive"},
    {id:"cg_ok", label:"Orientation OK", phrase:"orientation préservée"}
  ]},
  {id:"insight", label:"Insight / jugement", items:[
    {id:"in_ok", label:"Insight présent", phrase:"insight présent"},
    {id:"in_part", label:"Insight partiel", phrase:"insight partiel"},
    {id:"in_judg", label:"Jugement fragile", phrase:"jugement à surveiller"}
  ]},
  {id:"risk", label:"Sécurité", items:[
    {id:"rk_none", label:"Pas d’idéation suicidaire active", phrase:"pas d’idéation suicidaire active"},
    {id:"rk_diff", label:"Idées noires diffuses", phrase:"idées noires diffuses"},
    {id:"rk_plan", label:"Plan/intentionalité (à préciser)", phrase:"éléments d’idéation suicidaire avec plan (à préciser)"}
  ]}
];

// Prise en charge / plan
const CARE = {
  title:"Prise en charge",
  items:[
    {id:"ca_follow", label:"Suivi psy régulier", phrase:"poursuite d’un suivi psychiatrique régulier"},
    {id:"ca_psy", label:"Suivi psychologue", phrase:"suivi psychothérapeutique en cours"},
    {id:"ca_hdj", label:"HDJ", phrase:"mise en place d’une prise en charge en hôpital de jour"},
    {id:"ca_group", label:"Groupe psychoéducation", phrase:"proposition d’intégration dans un groupe de psychoéducation"},
    {id:"ca_tools", label:"Régulation émotionnelle", phrase:"travail de psychoéducation et régulation émotionnelle"}
  ]
};

const WORK = {
  title:"Travail",
  items:[
    {id:"wk_no", label:"Non compatible", phrase:"À ce stade, l’état clinique actuel n’est pas compatible avec une reprise d’activité professionnelle."},
    {id:"wk_part", label:"Partiel à discuter", phrase:"Une reprise partielle/progressive pourra être discutée selon l’évolution."},
    {id:"wk_ok", label:"Compatible", phrase:"L’évolution est compatible avec une reprise progressive (à cadrer)."}
  ]
};

// Emails
const EMAIL_TPL = [
  {
    id:"em_attach",
    name:"Envoi document en pièce jointe",
    subject:"Transmission du document",
    fields:["toName","context","attachmentName"],
    body:(v)=>`Bonjour ${v.toName||""},

Veuillez trouver en pièce jointe ${v.attachmentName||"le document demandé"}.
${v.context?("\n"+v.context+"\n"):""}

Bien à vous,
${v.signature||""}`.trim()
  },
  {
    id:"em_resched",
    name:"Changement de rendez-vous",
    subject:"Modification de rendez-vous",
    fields:["toName","oldDate","newDate","reason"],
    body:(v)=>`Bonjour ${v.toName||""},

Je reviens vers vous concernant le rendez-vous prévu le ${v.oldDate||"__"}.
Je vous propose de le déplacer au ${v.newDate||"__"}.
${v.reason?("\nMotif : "+v.reason+"\n"):""}

Merci de me confirmer si cela vous convient.

Bien à vous,
${v.signature||""}`.trim()
  },
  {
    id:"em_ack",
    name:"Accusé de réception (je réponds plus tard)",
    subject:"Bien reçu",
    fields:["toName","topic"],
    body:(v)=>`Bonjour ${v.toName||""},

Bien reçu pour votre message${v.topic?(" concernant "+v.topic):""}.
Je prends note et je reviens vers vous dès que possible.

Bien à vous,
${v.signature||""}`.trim()
  },
  {
    id:"em_request",
    name:"Demande d’informations/documents",
    subject:"Demande d’informations",
    fields:["toName","request"],
    body:(v)=>`Bonjour ${v.toName||""},

Afin de pouvoir finaliser le suivi/les démarches, auriez-vous la possibilité de me transmettre ${v.request||"les éléments suivants"} ?

Merci d’avance.

Bien à vous,
${v.signature||""}`.trim()
  }
];

/* ---------- Clinical templates ---------- */
const CLIN_TPL = [
  {
    id:"cl_att_work",
    name:"Attestation / travail (anxiété au 1er plan)",
    build:(v)=> {
      const p = pronouns(v.civilite);
      const ident = v.identite || "la personne";
      const dx = v.diagnostic || "un trouble anxiodépressif";
      const ctx = v.contextFree ? `Contexte : ${v.contextFree.trim()}.` : "";
      const clin = buildClinicalNarrative(v);
      const care = buildCareNarrative(v);
      const work = buildWorkNarrative(v);

      return cleanSpaces(`
Attestation médicale

Je vois en consultation de psychiatrie ${ident} pour ${dx}.
${ctx}

Sur le plan clinique, ${clin}

La prise en charge consiste en ${care}

${work}

Fait pour servir et valoir ce que de droit.
— ${todayFR()}
      `);
    }
  },
  {
    id:"cl_consult",
    name:"Note de consultation (nouveau suivi)",
    build:(v)=> {
      const ident = v.identite || "la personne";
      const dx = v.diagnostic || "(à préciser)";
      const ctx = v.contextFree ? v.contextFree.trim() : "—";
      const clin = buildClinicalNarrative(v);
      const care = buildCareNarrative(v);

      return cleanSpaces(`
Consultation psychiatrique — ${todayFR()}

Contexte : ${ctx}

Je vois ${ident} pour ${dx}.

Sur le plan clinique, ${clin}

Plan : ${care}
      `);
    }
  },
  {
    id:"cl_evol",
    name:"Note d’évolution (hospitalisation)",
    build:(v)=> {
      const evol = v.evolutionFree ? v.evolutionFree.trim() : "—";
      const clin = buildClinicalNarrative(v);
      const care = buildCareNarrative(v);
      return cleanSpaces(`
Note d’évolution — ${todayFR()}

Évolution : ${evol}

Sur le plan clinique, ${clin}

Plan : ${care}
      `);
    }
  },
  {
    id:"cl_sevrage_s1_adm",
    name:"Sevrage alcool — admission semaine 1",
    build:(v)=> {
      const ident = v.identite || "la personne";
      const ctx = v.contextFree ? v.contextFree.trim() : "—";
      const mse = buildMSENarrative(v, true);
      const add = buildAddictoSentence(v);
      return cleanSpaces(`
Admission — Sevrage alcool (Semaine 1) — ${todayFR()}

Patient·e : ${ident}

Contexte : ${ctx}

Consommations : ${add}

Examen mental : ${mse}

Schéma de sevrage : voir tableau (ou prescription dédiée selon organisation).

Plan : ${buildCareNarrative(v)}
      `);
    }
  },
  {
    id:"cl_sevrage_s1_out",
    name:"Sevrage alcool — sortie semaine 1",
    build:(v)=> {
      const ident = v.identite || "la personne";
      const evol = v.evolutionFree ? v.evolutionFree.trim() : "—";
      const mse = buildMSENarrative(v, true);
      return cleanSpaces(`
Sortie — Sevrage alcool (Fin semaine 1) — ${todayFR()}

Patient·e : ${ident}

Bilan : ${evol}

Examen mental : ${mse}

Plan / semaine intermédiaire : ${buildCareNarrative(v)}
      `);
    }
  },
  {
    id:"cl_sevrage_s2_out",
    name:"Sevrage alcool — sortie semaine 2",
    build:(v)=> {
      const ident = v.identite || "la personne";
      const evol = v.evolutionFree ? v.evolutionFree.trim() : "—";
      const mse = buildMSENarrative(v, true);
      const add = buildAddictoSentence(v);
      return cleanSpaces(`
Sortie — Sevrage alcool (Fin semaine 2) — ${todayFR()}

Patient·e : ${ident}

Bilan : ${evol}

Consommations / prévention : ${add}

Examen mental : ${mse}

Plan : ${buildCareNarrative(v)}
      `);
    }
  }
];

/* ---------- State ---------- */
let state = {
  theme: "dark",
  focus: false,
  sidebarHidden: false,
  ui: "compact",          // compact | full
  mode: "clinical",       // clinical | email | taper
  activeTplId: "cl_att_work",
  // values stored per template (and per mode)
  values: {},
  // output visible
  outputVisible: true
};

/* ---------- Load/Save ---------- */
function load(){
  const raw = localStorage.getItem(LS_KEY);
  if(raw){
    try{ state = {...state, ...JSON.parse(raw)}; }catch(e){}
  }
  applyTheme(state.theme);
  applyFocus(state.focus);
  applySidebarHidden(state.sidebarHidden);
  $("mode").value = state.mode;
  $("civilite").value = getGlobal("civilite","N");
  $("identite").value = getGlobal("identite","");
  $("signature").value = getGlobal("signature","");
  state.activeTplId = ensureActiveTpl(state.mode, state.activeTplId);
  renderAll();
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
}
function setGlobal(key, val){
  state.values.__global = state.values.__global || {};
  state.values.__global[key] = val;
  save();
}
function getGlobal(key, fallback=""){
  return (state.values.__global && state.values.__global[key] !== undefined)
    ? state.values.__global[key] : fallback;
}
function getTplValues(tplId){
  state.values[tplId] = state.values[tplId] || {};
  return state.values[tplId];
}
function setTplValue(tplId, key, val){
  const v = getTplValues(tplId);
  v[key]=val;
  save();
}

/* ---------- Theme / Focus / Sidebar ---------- */
function applyTheme(t){
  document.body.setAttribute("data-theme", t);
  state.theme = t;
  save();
}
function applyFocus(on){
  document.body.classList.toggle("focus", !!on);
  state.focus = !!on;
  save();
}
function applySidebarHidden(on){
  $("sidebar").style.display = on ? "none" : "block";
  state.sidebarHidden = !!on;
  save();
}

/* ---------- Template handling ---------- */
function ensureActiveTpl(mode, activeId){
  const list = mode==="clinical" ? CLIN_TPL
             : mode==="email" ? EMAIL_TPL
             : [{id:"taper_main", name:"Schéma sevrage"}];
  if(list.some(t=>t.id===activeId)) return activeId;
  return list[0].id;
}
function listTemplates(){
  const q = ($("searchTpl").value||"").toLowerCase().trim();
  let list = [];
  if(state.mode==="clinical"){
    list = CLIN_TPL.map(t=>({id:t.id, name:t.name, cat:"Clinique"}));
  } else if(state.mode==="email"){
    list = EMAIL_TPL.map(t=>({id:t.id, name:t.name, cat:"Email"}));
  } else {
    list = [{id:"taper_main", name:"Schéma sevrage", cat:"Sevrage"}];
  }
  if(q){
    list = list.filter(x=> (x.name+" "+x.cat).toLowerCase().includes(q));
  }
  return list;
}
function activeTemplate(){
  if(state.mode==="clinical"){
    return CLIN_TPL.find(t=>t.id===state.activeTplId) || CLIN_TPL[0];
  }
  if(state.mode==="email"){
    return EMAIL_TPL.find(t=>t.id===state.activeTplId) || EMAIL_TPL[0];
  }
  return {id:"taper_main", name:"Schéma sevrage"};
}

/* ---------- Builders: fluent narrative ---------- */
function buildSyndromeSentence(v){
  const packId = v.pack || "anxiodepressif";
  const pack = PACKS[packId] || PACKS.anxiodepressif;
  const sel = v.synSel || [];
  const phrases = sel
    .map(id => pack.items.find(x=>x.id===id))
    .filter(Boolean)
    .map(it=>it.phrase);

  const free = (v.synFree||"").trim();
  const chunk = sentenceJoin(phrases);
  if(chunk && free) return chunk + ". " + free;
  if(chunk) return chunk;
  if(free) return free;
  return "—";
}

function buildAddictoSentence(v){
  const sel = v.addSel || [];
  const phrases = sel
    .map(id => ADDICTO.items.find(x=>x.id===id))
    .filter(Boolean)
    .map(it=>it.phrase);
  const free = (v.addFree||"").trim();

  const chunk = sentenceJoin(phrases);
  if(chunk && free) return chunk + ", " + free;
  if(chunk) return chunk;
  if(free) return free;
  return "non documenté";
}

function buildMSENarrative(v, includeAddicto){
  // Produit 2–4 phrases fluides, pas une liste
  const selectedByDomain = v.mseSel || {}; // {domainId: [itemIds]}
  const pickPhrase = (domainId)=>{
    const dom = MSE.find(d=>d.id===domainId);
    const sel = (selectedByDomain[domainId]||[]);
    if(!dom || !sel.length) return [];
    return sel
      .map(id=>dom.items.find(x=>x.id===id))
      .filter(Boolean)
      .map(it=>it.phrase);
  };

  const app = pickPhrase("app");
  const contact = pickPhrase("contact");
  const disc = pickPhrase("disc");
  const mood = pickPhrase("mood");
  const thought = pickPhrase("thought");
  const percep = pickPhrase("percep");
  const cogn = pickPhrase("cogn");
  const insight = pickPhrase("insight");
  const risk = pickPhrase("risk");

  const s1 = [];
  if(app.length || contact.length){
    s1.push("Lors de l’entretien, la personne se présente");
    s1.push(sentenceJoin([...app, ...contact]));
  }
  const s2 = disc.length ? ("Le " + (disc[0].startsWith("discours")?"": "discours est ") + sentenceJoin(disc).replace(/^discours\s+/,"")) : "";
  const s3 = mood.length ? ("Sur le plan thymique, " + sentenceJoin(mood)) : "";
  const s4 = thought.length ? ("Sur le plan de la pensée, " + sentenceJoin(thought)) : "";
  // perceptions: si "aucun trouble perceptif rapporté" est coché, on formule proprement
  let s5 = "";
  if(percep.length){
    const hasNone = percep.some(p=>p.includes("aucun trouble perceptif"));
    const hasHall = percep.some(p=>p.includes("troubles perceptifs rapportés"));
    if(hasNone && !hasHall){
      s5 = "Aucun trouble perceptif n’est rapporté.";
    } else {
      s5 = "Sur le plan perceptif, " + sentenceJoin(percep) + ".";
    }
  }

  const s6 = cogn.length ? ("Sur le plan cognitif, " + sentenceJoin(cogn) + ".") : "";
  const s7 = insight.length ? ("L’insight est " + sentenceJoin(insight).replace(/^insight\s+/,"") + ".") : "";
  const s8 = risk.length ? ("Concernant la sécurité, " + sentenceJoin(risk) + ".") : "";

  // consommations intégrées dans le paragraphe MSE
  let s9 = "";
  if(includeAddicto){
    const add = buildAddictoSentence(v);
    if(add && add !== "non documenté"){
      s9 = "Sur le plan des consommations, la personne rapporte " + add + ".";
    }
  }

  const sentences = [];
  if(s1.length) sentences.push(s1.join(" ") + ".");
  if(s2) sentences.push(s2.endsWith(".")?s2:(s2+"."));
  if(s3) sentences.push(s3.endsWith(".")?s3:(s3+"."));
  if(s4) sentences.push(s4.endsWith(".")?s4:(s4+"."));
  if(s5) sentences.push(s5);
  if(s6) sentences.push(s6);
  if(s7) sentences.push(s7);
  if(s8) sentences.push(s8);
  if(s9) sentences.push(s9);

  // fallback minimal
  return sentences.length ? sentences.join(" ") : "examen mental sans élément majeur mis en évidence ce jour.";
}

function buildCareNarrative(v){
  const sel = v.careSel || [];
  const phrases = sel
    .map(id=>CARE.items.find(x=>x.id===id))
    .filter(Boolean)
    .map(it=>it.phrase);

  // médication : champ libre + mini checkboxes
  const meds = (v.medsFree||"").trim();
  const base = sentenceJoin(phrases);
  if(base && meds) return base + ". Une médication est en place : " + meds + ".";
  if(base) return base + ".";
  if(meds) return "une médication est en place : " + meds + ".";
  return "à préciser selon l’évolution et les démarches en cours.";
}

function buildWorkNarrative(v){
  const sel = v.workSel || [];
  // règles simples : si plusieurs cochées -> on prend la plus "forte" wk_no > wk_part > wk_ok
  const priority = ["wk_no","wk_part","wk_ok"];
  const chosen = priority.find(id=>sel.includes(id));
  const it = WORK.items.find(x=>x.id===chosen);
  return it ? it.phrase : "La capacité de reprise professionnelle sera réévaluée selon l’évolution.";
}

function buildClinicalNarrative(v){
  // Clinique = syndrome + MSE + consommations intégrées
  const synd = buildSyndromeSentence(v);
  const mse = buildMSENarrative(v, true);
  // On fabrique un paragraphe fluide “comme tes rapports”
  const out = paragraphJoin([
    synd ? (synd.endsWith(".")?synd:(synd+".")) : "",
    "À l’examen mental, " + mse
  ]);
  return cleanSpaces(out);
}

/* ---------- Render sidebar template list ---------- */
function renderTplList(){
  const list = listTemplates();
  $("countTpl").textContent = `${list.length}`;
  const tplList = $("tplList");
  tplList.innerHTML = "";
  list.forEach(t=>{
    const div=document.createElement("div");
    div.className="item"+(t.id===state.activeTplId ? " active":"");
    div.innerHTML = `<b>${t.name}</b><small>${t.cat}</small>`;
    div.onclick = ()=>{
      state.activeTplId = t.id;
      save();
      renderAll();
    };
    tplList.appendChild(div);
  });
}

/* ---------- Render main content per mode ---------- */
function renderClinical(){
  const tpl = activeTemplate();
  const v = getTplValues(tpl.id);

  $("docTitle").textContent = "Clinique";
  $("chipMode").textContent = "Mode : Clinique";
  $("chipTpl").textContent = "Modèle : " + tpl.name;

  // Minimal fields
  const dxOptions = [
    "un trouble anxieux",
    "un trouble anxiodépressif",
    "un épisode dépressif",
    "un trouble de stress post-traumatique",
    "une dysrégulation émotionnelle / traits borderline",
    "un trouble lié à l’usage de substances",
    "(à préciser)"
  ];

  const packOptions = [
    {id:"anxieux", name:"Syndrome anxieux"},
    {id:"anxiodepressif", name:"Syndrome anxiodépressif"},
    {id:"depressif", name:"Syndrome dépressif"},
    {id:"traumatique", name:"Syndrome traumatique"}
  ];

  const compact = (state.ui==="compact");

  const html = `
    <div class="row">
      <div class="col">
        <label>Diagnostic (rapide)</label>
        <select id="diagnostic"></select>
      </div>
      <div class="col focusHide">
        <label>Contexte (court)</label>
        <input id="contextFree" placeholder="passage urgences, facteurs de stress, logement…" />
      </div>
    </div>

    <div class="section">
      <div class="sectionhead">
        <b>Clinique (cases → phrases)</b>
        <span class="small">tu coches, ça écrit propre</span>
      </div>

      <div class="row">
        <div class="col">
          <label>Pack</label>
          <select id="pack"></select>
        </div>
        <div class="col">
          <label>Phrase libre (optionnel, 1–2 lignes)</label>
          <input id="synFree" placeholder="ex. hypersensibilité au bruit, peur que ça explose…" />
        </div>
      </div>

      <div class="checkgrid" id="synGrid"></div>
    </div>

    ${compact ? "" : `
    <div class="section focusHide">
      <div class="sectionhead"><b>Consommations</b><span class="small">intégrées dans l’examen mental</span></div>
      <div class="checkgrid" id="addGrid"></div>
      <label>Complément libre (optionnel)</label>
      <input id="addFree" placeholder="ex. consommation diminuée, sport ressource…" />
    </div>
    `}

    <div class="section">
      <div class="sectionhead">
        <b>Examen mental (fluide)</b>
        <span class="small">macros + multi-cases</span>
      </div>

      <div class="row">
        <button class="btn ok" id="mx_ok">Macro : Standard OK</button>
        <button class="btn" id="mx_anx">Macro : Anxieux typique</button>
        <button class="btn warn" id="mx_add">Macro : Addicto typique</button>
        <button class="btn bad" id="mx_clear">Tout décocher</button>
      </div>

      <div id="mseArea"></div>
    </div>

    <div class="section">
      <div class="sectionhead"><b>Prise en charge</b><span class="small">cases + 1 champ médication</span></div>
      <div class="checkgrid" id="careGrid"></div>
      <label>Médication (documentation, libre)</label>
      <input id="medsFree" placeholder="ex. hydroxyzine si besoin, ISRS…, etc." />
    </div>

    <div class="section ${compact ? "focusHide":""}">
      <div class="sectionhead"><b>Travail</b><span class="small">choisir l’idée principale</span></div>
      <div class="checkgrid" id="workGrid"></div>
    </div>

    <div class="section ${compact ? "focusHide":""}">
      <div class="sectionhead"><b>Évolution (libre)</b></div>
      <textarea id="evolutionFree" class="mono" placeholder="évolution lente stable, démarches, HDJ, etc."></textarea>
    </div>
  `;

  $("content").innerHTML = html;

  // Diagnostic select
  const dxSel = $("diagnostic");
  dxOptions.forEach(x=>{
    const o=document.createElement("option");
    o.value=x; o.textContent=x;
    dxSel.appendChild(o);
  });
  dxSel.value = v.diagnostic || "un trouble anxiodépressif";
  dxSel.onchange = e => setTplValue(tpl.id,"diagnostic", e.target.value);

  // Contexte
  if($("contextFree")){
    $("contextFree").value = v.contextFree || "";
    $("contextFree").oninput = e => setTplValue(tpl.id,"contextFree", e.target.value);
  }

  // Pack select
  const pkSel = $("pack");
  packOptions.forEach(p=>{
    const o=document.createElement("option");
    o.value=p.id; o.textContent=p.name;
    pkSel.appendChild(o);
  });
  pkSel.value = v.pack || "anxiodepressif";
  pkSel.onchange = e=>{
    setTplValue(tpl.id,"pack", e.target.value);
    renderAll(); // refresh checklist
  };

  // Syn free
  $("synFree").value = v.synFree || "";
  $("synFree").oninput = e => setTplValue(tpl.id,"synFree", e.target.value);

  // Syndrome checklist
  const packId = pkSel.value;
  const pack = PACKS[packId];
  const synGrid = $("synGrid");
  synGrid.innerHTML = "";
  const synSel = v.synSel || [];
  pack.items.forEach(it=>{
    checkboxItem(synGrid, it, synSel.includes(it.id), (ok)=>{
      const next = ok ? [...new Set([...synSel, it.id])] : synSel.filter(x=>x!==it.id);
      setTplValue(tpl.id,"synSel", next);
      $("output").value = generate();
    });
  });

  // Addictions (only if visible)
  if($("addGrid")){
    const addGrid = $("addGrid");
    addGrid.innerHTML="";
    const addSel = v.addSel || [];
    ADDICTO.items.forEach(it=>{
      checkboxItem(addGrid, it, addSel.includes(it.id), (ok)=>{
        const next = ok ? [...new Set([...addSel, it.id])] : addSel.filter(x=>x!==it.id);
        setTplValue(tpl.id,"addSel", next);
        $("output").value = generate();
      });
    });

    $("addFree").value = v.addFree || "";
    $("addFree").oninput = e => setTplValue(tpl.id,"addFree", e.target.value);
  }

  // MSE render
  renderMSEArea(tpl.id);

  // Care grid
  const careGrid = $("careGrid");
  const careSel = v.careSel || [];
  careGrid.innerHTML="";
  CARE.items.forEach(it=>{
    checkboxItem(careGrid, it, careSel.includes(it.id), (ok)=>{
      const next = ok ? [...new Set([...careSel, it.id])] : careSel.filter(x=>x!==it.id);
      setTplValue(tpl.id,"careSel", next);
      $("output").value = generate();
    });
  });

  // Meds free
  $("medsFree").value = v.medsFree || "";
  $("medsFree").oninput = e => setTplValue(tpl.id,"medsFree", e.target.value);

  // Work grid
  if($("workGrid")){
    const workGrid = $("workGrid");
    const workSel = v.workSel || [];
    workGrid.innerHTML="";
    WORK.items.forEach(it=>{
      checkboxItem(workGrid, it, workSel.includes(it.id), (ok)=>{
        // pour éviter contradictions : on garde 1 seul “état” principal
        let next = workSel.filter(x=>!["wk_no","wk_part","wk_ok"].includes(x));
        if(ok) next = [...next, it.id];
        setTplValue(tpl.id,"workSel", next);
        $("output").value = generate();
        renderAll(); // refresh to show single selection properly
      });
    });
  }

  // Evolution free
  if($("evolutionFree")){
    $("evolutionFree").value = v.evolutionFree || "";
    $("evolutionFree").oninput = e => setTplValue(tpl.id,"evolutionFree", e.target.value);
  }
}

function renderMSEArea(tplId){
  const v = getTplValues(tplId);
  const area = $("mseArea");
  area.innerHTML = "";

  // helper
  const mseSel = v.mseSel || {}; // {domainId:[itemIds]}
  function setDomain(domainId, arr){
    mseSel[domainId] = arr;
    setTplValue(tplId,"mseSel", mseSel);
  }

  // macros
  $("mx_ok").onclick = ()=>{
    setDomain("app", ["app_ok"]);
    setDomain("contact", ["ct_ok","ct_coll"]);
    setDomain("disc", ["ds_coh"]);
    setDomain("mood", ["md_ok"]);
    setDomain("thought", []);
    setDomain("percep", ["pc_none"]);
    setDomain("cogn", ["cg_ok"]);
    setDomain("insight", ["in_ok"]);
    setDomain("risk", ["rk_none"]);
    $("output").value = generate();
    renderAll();
  };
  $("mx_anx").onclick = ()=>{
    setDomain("app", ["app_fat"]);
    setDomain("contact", ["ct_ok","ct_coll"]);
    setDomain("disc", ["ds_coh"]);
    setDomain("mood", ["md_anx","md_lab"]);
    setDomain("thought", ["th_rum"]);
    setDomain("percep", ["pc_none","pc_hyp"]);
    setDomain("cogn", ["cg_att","cg_fat"]);
    setDomain("insight", ["in_ok"]);
    setDomain("risk", ["rk_diff"]);
    $("output").value = generate();
    renderAll();
  };
  $("mx_add").onclick = ()=>{
    setDomain("app", ["app_fat"]);
    setDomain("contact", ["ct_coll"]);
    setDomain("disc", ["ds_coh"]);
    setDomain("mood", ["md_anx","md_irr"]);
    setDomain("thought", ["th_rum"]);
    setDomain("percep", ["pc_none"]);
    setDomain("cogn", ["cg_att"]);
    setDomain("insight", ["in_part"]);
    setDomain("risk", ["rk_none"]);
    // Optionnel: pré-cocher conso
    const vv = getTplValues(tplId);
    const addSel = vv.addSel || [];
    const next = [...new Set([...addSel, "sub_alc", "sub_red"])];
    setTplValue(tplId,"addSel", next);
    $("output").value = generate();
    renderAll();
  };
  $("mx_clear").onclick = ()=>{
    MSE.forEach(d=> setDomain(d.id, []));
    $("output").value = generate();
    renderAll();
  };

  // domains
  MSE.forEach(dom=>{
    const sec = document.createElement("div");
    sec.className="section";
    sec.innerHTML = `<div class="sectionhead"><b>${dom.label}</b><span class="small">(multi)</span></div>`;
    const grid = document.createElement("div");
    grid.className="checkgrid";

    const sel = mseSel[dom.id] || [];
    dom.items.forEach(it=>{
      checkboxItem(grid, it, sel.includes(it.id), (ok)=>{
        const next = ok ? [...new Set([...sel, it.id])] : sel.filter(x=>x!==it.id);
        mseSel[dom.id]=next;
        setTplValue(tplId,"mseSel", mseSel);
        $("output").value = generate();
      });
    });

    sec.appendChild(grid);
    area.appendChild(sec);
  });
}

function renderEmail(){
  const tpl = activeTemplate();
  const v = getTplValues(tpl.id);

  $("docTitle").textContent = "Email";
  $("chipMode").textContent = "Mode : Email";
  $("chipTpl").textContent = "Modèle : " + tpl.name;

  const html = `
    <div class="row">
      <div class="col">
        <label>Destinataire (nom)</label>
        <input id="toName" placeholder="Mme … / M. … / Dr …" />
      </div>
      <div class="col">
        <label>Objet</label>
        <input id="subject" />
      </div>
    </div>

    <div class="section">
      <div class="sectionhead"><b>Champs du modèle</b><span class="small">rapide</span></div>
      <div id="emailFields"></div>
    </div>

    <div class="section">
      <div class="sectionhead"><b>Notes (optionnel)</b></div>
      <input id="context" placeholder="ajouter une phrase / précision..." />
    </div>
  `;
  $("content").innerHTML = html;

  // Base fields
  $("toName").value = v.toName || "";
  $("subject").value = v.subject || tpl.subject || "";
  $("context").value = v.context || "";

  $("toName").oninput = e => setTplValue(tpl.id,"toName", e.target.value);
  $("subject").oninput = e => setTplValue(tpl.id,"subject", e.target.value);
  $("context").oninput = e => setTplValue(tpl.id,"context", e.target.value);

  const wrap = $("emailFields");
  wrap.innerHTML = "";

  // model-specific fields
  const fields = tpl.fields || [];
  fields.forEach(f=>{
    const lab = document.createElement("label");
    lab.textContent = fieldLabel(f);
    const inp = document.createElement("input");
    inp.id = f;
    inp.value = v[f] || "";
    inp.placeholder = fieldPlaceholder(f);
    inp.oninput = (e)=> setTplValue(tpl.id, f, e.target.value);
    wrap.appendChild(lab);
    wrap.appendChild(inp);
  });

  // default subject if empty
  if(!$("subject").value) $("subject").value = tpl.subject || "—";
}

function fieldLabel(f){
  const map = {
    toName:"Destinataire",
    context:"Contexte",
    attachmentName:"Nom du document",
    oldDate:"Ancienne date",
    newDate:"Nouvelle date",
    reason:"Motif",
    topic:"Sujet",
    request:"Ce que tu demandes"
  };
  return map[f] || f;
}
function fieldPlaceholder(f){
  const map = {
    attachmentName:"ex. le rapport / l’attestation / la note",
    oldDate:"ex. 12/02/2026 à 14h",
    newDate:"ex. 18/02/2026 à 10h",
    reason:"ex. contrainte d’agenda",
    topic:"ex. rendez-vous / document",
    request:"ex. documents / informations nécessaires"
  };
  return map[f] || "";
}

function renderTaper(){
  $("docTitle").textContent = "Sevrage";
  $("chipMode").textContent = "Mode : Schéma sevrage";
  $("chipTpl").textContent = "Modèle : tableau auto";

  const id = "taper_main";
  const v = getTplValues(id);

  const html = `
    <div class="row">
      <div class="col">
        <label>Date de début</label>
        <input type="date" id="taperDate" />
      </div>
      <div class="col">
        <label>Molécule</label>
        <select id="taperMol">
          <option value="valium">Valium (diazépam)</option>
          <option value="temesta">Ténesta (lorazépam)</option>
        </select>
      </div>
      <div class="col">
        <label>Dose de départ</label>
        <select id="taperStart"></select>
      </div>
    </div>

    <div class="section">
      <div class="sectionhead"><b>J1 — répartition (8h/12h/18h/22h)</b><span class="small">total auto</span></div>
      <div class="row">
        <div class="col"><label>8h</label><input id="d8" type="number" step="0.25"/></div>
        <div class="col"><label>12h</label><input id="d12" type="number" step="0.25"/></div>
        <div class="col"><label>18h</label><input id="d18" type="number" step="0.25"/></div>
        <div class="col"><label>22h</label><input id="d22" type="number" step="0.25"/></div>
        <div class="col"><label>Total J1</label><input id="dTot" disabled/></div>
      </div>
      <div class="row">
        <button class="btn ok" id="btnEven">Répartir égal</button>
        <button class="btn" id="btnAuto">Générer tableau auto</button>
      </div>
      <small class="small">
        Règle auto: J1–J2 identiques, puis diminution chaque jour jusqu’à la dose cible “10 mg Valium” ou “2.5 mg Ténesta” (prise unique matin).
      </small>
    </div>

    <div class="section">
      <div class="sectionhead"><b>Tableau (modifiable)</b><span class="small">copiable</span></div>
      <textarea id="taperTable" class="mono" style="min-height:260px;"></textarea>
    </div>
  `;
  $("content").innerHTML = html;

  // init date
  $("taperDate").value = v.taperDate || todayISO();
  $("taperMol").value = v.taperMol || "valium";

  // start dose options
  function fillStart(){
    const mol = $("taperMol").value;
    const sel = $("taperStart");
    sel.innerHTML = "";
    const opts = (mol==="valium")
      ? [20,40,50,60]
      : [8.75,10];
    opts.forEach(x=>{
      const o=document.createElement("option");
      o.value=String(x); o.textContent=String(x);
      sel.appendChild(o);
    });
    sel.value = (v.taperStart !== undefined) ? String(v.taperStart) : String(opts[0]);
  }
  fillStart();

  // J1 split
  $("d8").value = (v.d8 !== undefined) ? v.d8 : "";
  $("d12").value = (v.d12 !== undefined) ? v.d12 : "";
  $("d18").value = (v.d18 !== undefined) ? v.d18 : "";
  $("d22").value = (v.d22 !== undefined) ? v.d22 : "";

  function updateTotal(){
    const a = parseFloat($("d8").value||"0");
    const b = parseFloat($("d12").value||"0");
    const c = parseFloat($("d18").value||"0");
    const d = parseFloat($("d22").value||"0");
    const tot = a+b+c+d;
    $("dTot").value = isFinite(tot) ? tot.toFixed(2).replace(/\.00$/,"") : "";
    setTplValue(id,"d8", a); setTplValue(id,"d12", b); setTplValue(id,"d18", c); setTplValue(id,"d22", d);
  }
  ["d8","d12","d18","d22"].forEach(k=>{
    $(k).oninput = updateTotal;
  });

  $("taperDate").onchange = e => setTplValue(id,"taperDate", e.target.value);
  $("taperMol").onchange = e => {
    setTplValue(id,"taperMol", e.target.value);
    fillStart();
    renderAll(); // refresh view coherent
  };
  $("taperStart").onchange = e => setTplValue(id,"taperStart", e.target.value);

  $("btnEven").onclick = ()=>{
    const mol = $("taperMol").value;
    const start = parseFloat($("taperStart").value);
    const per = start/4;
    $("d8").value = per;
    $("d12").value = per;
    $("d18").value = per;
    $("d22").value = per;
    updateTotal();
  };

  $("btnAuto").onclick = ()=>{
    updateTotal();
    const startDate = $("taperDate").value;
    const mol = $("taperMol").value;
    const start = parseFloat($("taperStart").value);

    // read J1 split (if empty -> equal)
    let s8 = parseFloat($("d8").value||"0");
    let s12 = parseFloat($("d12").value||"0");
    let s18 = parseFloat($("d18").value||"0");
    let s22 = parseFloat($("d22").value||"0");
    if((s8+s12+s18+s22)===0){
      const per = start/4;
      s8=s12=s18=s22=per;
      $("d8").value=per; $("d12").value=per; $("d18").value=per; $("d22").value=per;
      updateTotal();
    }

    const table = generateTaperTable({
      startDate,
      mol,
      startDose:start,
      split:{h8:s8,h12:s12,h18:s18,h22:s22}
    });

    $("taperTable").value = table;
    setTplValue(id,"taperTable", table);
  };

  $("taperTable").value = v.taperTable || "";
  $("taperTable").oninput = e => setTplValue(id,"taperTable", e.target.value);

  updateTotal();
}

/* ---------- Sevrage generator ---------- */
function addDaysISO(dateISO, n){
  const d = new Date(dateISO+"T00:00:00");
  d.setDate(d.getDate()+n);
  const pad=x=>String(x).padStart(2,"0");
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
}
function fmtFR(dateISO){
  const [y,m,d]=dateISO.split("-"); return `${d}/${m}/${y}`;
}
function generateTaperTable({startDate, mol, startDose, split}){
  // rules:
  // - day1-2 same total
  // - then decrement by step until target
  //   valium: step 5 mg, target 10 mg (single morning)
  //   temesta: step 1.25 mg, target 2.5 mg (single morning)
  // - distribution: by default scale original split proportionally, except last day = morning only target
  const lines = [];
  const step = (mol==="valium") ? 5 : 1.25;
  const target = (mol==="valium") ? 10 : 2.5;

  // proportions from J1 split
  const tot0 = split.h8+split.h12+split.h18+split.h22;
  const p8 = tot0 ? split.h8/tot0 : 0.25;
  const p12 = tot0 ? split.h12/tot0 : 0.25;
  const p18 = tot0 ? split.h18/tot0 : 0.25;
  const p22 = tot0 ? split.h22/tot0 : 0.25;

  // build totals array
  const totals = [];
  totals.push(startDose);
  totals.push(startDose);

  let cur = startDose;
  while(cur > target){
    cur = Math.max(target, +(cur - step).toFixed(2));
    totals.push(cur);
    if(cur===target) break;
  }

  // force last day = target single morning
  // (If target already reached earlier, keep last as target anyway)
  const lastIndex = totals.length-1;

  lines.push(`${mol==="valium" ? "VALIUM (diazépam)" : "TÉNESTA (lorazépam)"} — Début: ${fmtFR(startDate)} — Dose départ: ${startDose} mg`);
  lines.push(`Règle: J1–J2 identiques, puis décroissance par paliers (${step} mg/j) jusqu’à ${target} mg (prise unique matin).`);
  lines.push("");
  lines.push("Jour | Date | 8h | 12h | 18h | 22h | Total");
  lines.push("-----|------|----|-----|-----|-----|------");

  totals.forEach((t, i)=>{
    const date = addDaysISO(startDate, i);
    let d8=0,d12=0,d18=0,d22=0;

    if(i===lastIndex){
      d8 = target; d12=d18=d22=0;
    } else {
      // proportional scaling
      d8 = +(t*p8).toFixed(2);
      d12 = +(t*p12).toFixed(2);
      d18 = +(t*p18).toFixed(2);
      d22 = +(t*p22).toFixed(2);
      // small correction to match total
      const sum = d8+d12+d18+d22;
      const diff = +(t - sum).toFixed(2);
      d8 = +(d8 + diff).toFixed(2);
    }

    const line = `${String(i+1).padStart(2," ")} | ${fmtFR(date)} | ${fmtDose(d8)} | ${fmtDose(d12)} | ${fmtDose(d18)} | ${fmtDose(d22)} | ${fmtDose(d8+d12+d18+d22)}`;
    lines.push(line);
  });

  lines.push("");
  lines.push("Notes : tableau généré pour mise en forme. Adapter selon clinique/prescription locale.");
  return lines.join("\n");
}
function fmtDose(x){
  // display without trailing .00
  const s = (Math.round(x*100)/100).toString();
  return s;
}

/* ---------- Generate output ---------- */
function generate(){
  const tpl = activeTemplate();
  // enrich v with global fields
  const g = state.values.__global || {};
  if(state.mode==="clinical"){
    const v = getTplValues(tpl.id);
    v.identite = g.identite || v.identite;
    v.civilite = g.civilite || v.civilite || "N";
    return tpl.build(v);
  }
  if(state.mode==="email"){
    const v = getTplValues(tpl.id);
    v.signature = g.signature || v.signature;
    // subject stored per tpl, default from template
    const subj = (v.subject && v.subject.trim()) ? v.subject : tpl.subject;
    const body = tpl.body(v);
    return cleanSpaces(`Objet : ${subj}\n\n${body}`);
  }
  if(state.mode==="taper"){
    // output = table
    const v = getTplValues("taper_main");
    const txt = v.taperTable || "";
    return cleanSpaces(txt);
  }
  return "";
}

/* ---------- Export/Import ---------- */
function exportAll(){
  const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `psywriter-export-${Date.now()}.json`;
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 2500);
}
function importAll(){
  const inp = document.createElement("input");
  inp.type="file";
  inp.accept="application/json";
  inp.onchange = async ()=>{
    const f = inp.files[0]; if(!f) return;
    const txt = await f.text();
    try{
      const data = JSON.parse(txt);
      state = {...state, ...data};
      // normalize
      state.mode = state.mode || "clinical";
      state.activeTplId = ensureActiveTpl(state.mode, state.activeTplId);
      applyTheme(state.theme || "dark");
      applyFocus(!!state.focus);
      applySidebarHidden(!!state.sidebarHidden);
      $("mode").value = state.mode;
      $("outputWrap").style.display = state.outputVisible ? "block" : "none";
      renderAll();
      save();
      alert("Import OK.");
    }catch(e){
      alert("Import invalide : " + e.message);
    }
  };
  inp.click();
}
function resetAll(){
  if(!confirm("Reset complet ?")) return;
  localStorage.removeItem(LS_KEY);
  location.reload();
}

/* ---------- Render all ---------- */
function renderAll(){
  // sync global inputs
  $("civilite").value = getGlobal("civilite","N");
  $("identite").value = getGlobal("identite","");
  $("signature").value = getGlobal("signature","");

  // sidebar tpl list
  renderTplList();

  // content
  const tpl = activeTemplate();
  if(state.mode==="clinical") renderClinical();
  else if(state.mode==="email") renderEmail();
  else renderTaper();

  // output
  const txt = generate();
  $("output").value = txt;

  $("chipMode").textContent = "Mode : " + (state.mode==="clinical" ? "Clinique" : state.mode==="email" ? "Email" : "Sevrage");
  $("chipTpl").textContent = "Modèle : " + (tpl.name || "—");

  // output visible
  $("outputWrap").style.display = state.outputVisible ? "block" : "none";
}

/* ---------- Events ---------- */
$("btnTheme").onclick = ()=>{
  applyTheme(state.theme==="dark" ? "light" : "dark");
};

$("btnFocus").onclick = ()=>{
  applyFocus(!state.focus);
};

$("btnHideSide").onclick = ()=>{
  applySidebarHidden(true);
};

document.addEventListener("keydown",(e)=>{
  // ESC montre sidebar si cachée
  if(e.key==="Escape" && state.sidebarHidden){
    applySidebarHidden(false);
    renderAll();
  }
});

$("btnGenerate").onclick = ()=> { $("output").value = generate(); };
$("btnGenerate2").onclick = ()=> { $("output").value = generate(); };

function copyOut(){
  $("output").select();
  document.execCommand("copy");
}
$("btnCopy").onclick = copyOut;
$("btnCopy2").onclick = copyOut;

$("btnExport").onclick = exportAll;
$("btnImport").onclick = importAll;
$("btnReset").onclick = resetAll;

$("btnToggleOut").onclick = ()=>{
  state.outputVisible = !state.outputVisible;
  save();
  renderAll();
};

$("btnClear").onclick = ()=>{
  const tpl = activeTemplate();
  if(state.mode==="taper"){
    state.values["taper_main"] = {};
  } else {
    state.values[tpl.id] = {};
  }
  save();
  renderAll();
};

$("btnCompact").onclick = ()=>{
  state.ui = "compact"; save(); renderAll();
};
$("btnFull").onclick = ()=>{
  state.ui = "full"; save(); renderAll();
};

$("mode").onchange = (e)=>{
  state.mode = e.target.value;
  state.activeTplId = ensureActiveTpl(state.mode, state.activeTplId);
  save();
  renderAll();
};

$("searchTpl").oninput = renderTplList;

$("identite").oninput = (e)=>{ setGlobal("identite", e.target.value); renderAll(); };
$("civilite").onchange = (e)=>{ setGlobal("civilite", e.target.value); renderAll(); };
$("signature").oninput = (e)=>{ setGlobal("signature", e.target.value); renderAll(); };

/* ---------- Init ---------- */
load();
</script>
</body>
</html>
